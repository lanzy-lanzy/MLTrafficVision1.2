{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Video Feed Column -->
        <div class="lg:col-span-2">
            <div class="bg-white rounded-lg shadow-md overflow-hidden">
                <div class="relative">
                    <img src="{% url 'video_feed' %}" alt="Video Feed" class="w-full">
                    <div id="overlayStats" class="absolute top-0 left-0 bg-black bg-opacity-50 text-white p-2 text-sm">
                        <!-- Stats will be updated dynamically -->
                    </div>
                </div>
                <div class="p-4">
                    <div class="flex space-x-4">
                        <button onclick="startWebcam()" 
                                class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">
                            Start Webcam
                        </button>
                        <button onclick="stopVideo()" 
                                class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors">
                            Stop
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stats Column -->
        <div class="space-y-6">
            <!-- Current Stats -->
            <div class="space-y-6">
                <div class="bg-blue-50 p-4 sm:p-6 rounded-lg">
                    <h3 class="text-base sm:text-lg font-semibold text-blue-700 mb-3 sm:mb-4">Current Statistics</h3>
                    <div class="space-y-3 sm:space-y-4">
                        <div>
                            <label class="text-xs sm:text-sm text-gray-600">Vehicles Detected</label>
                            <p class="text-2xl sm:text-3xl font-bold text-blue-800" id="vehicle-count">0</p>
                        </div>
                        <div>
                            <label class="text-xs sm:text-sm text-gray-600">Congestion Level</label>
                            <p class="text-xl sm:text-2xl font-bold" id="congestion-level">Low</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 p-4 sm:p-6 rounded-lg">
                    <h3 class="text-base sm:text-lg font-semibold text-gray-700 mb-3">Vehicle Types</h3>
                    <div class="space-y-2" id="vehicle-types">
                        <!-- Vehicle types will be updated dynamically -->
                    </div>
                </div>
            </div>

            <!-- AI Insights Section -->
            <div id="ai-insights" class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 sm:p-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-indigo-900 mb-4">AI Traffic Insights</h3>
                <div id="assessment" class="mb-4">
                    <p class="text-gray-700 italic"></p>
                </div>
                <div id="concerns" class="mb-4">
                    <h4 class="font-medium text-red-800 mb-2">Potential Concerns:</h4>
                    <ul class="list-disc pl-5 space-y-2">
                        <!-- Concerns will be updated dynamically -->
                    </ul>
                </div>
                <div id="recommendations">
                    <h4 class="font-medium text-green-800 mb-2">Recommendations:</h4>
                    <ul class="list-disc pl-5 space-y-2">
                        <!-- Recommendations will be updated dynamically -->
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Function to update statistics
    function updateStats() {
        fetch('/get_stats/')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Update vehicle count
                document.getElementById('vehicle-count').textContent = data.vehicle_count || 0;
                
                // Update congestion level with color coding
                const congestionEl = document.getElementById('congestion-level');
                const level = data.congestion_level || 'LOW';
                congestionEl.textContent = level;
                congestionEl.className = 'text-xl font-bold ' + 
                    (level === 'HIGH' ? 'text-red-600' : 
                     level === 'MEDIUM' ? 'text-yellow-600' : 
                     'text-green-600');
                
                // Update vehicle types with percentage
                const vehicleTypesDiv = document.getElementById('vehicle-types');
                if (data.vehicle_types) {
                    const total = Object.values(data.vehicle_types).reduce((a, b) => a + b, 0);
                    vehicleTypesDiv.innerHTML = Object.entries(data.vehicle_types)
                        .map(([type, count]) => {
                            const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
                            return `
                                <div class="flex justify-between items-center py-1">
                                    <span class="text-sm text-gray-700">${type}</span>
                                    <div class="text-right">
                                        <span class="text-sm font-semibold text-blue-600">${count}</span>
                                        <span class="text-xs text-gray-500 ml-1">(${percentage}%)</span>
                                    </div>
                                </div>
                            `;
                        })
                        .join('');
                }

                // Update AI insights
                if (data.ai_insights && data.ai_insights.insights) {
                    const insights = data.ai_insights.insights;
                    
                    // Update assessment with fade effect
                    const assessmentEl = document.querySelector('#assessment p');
                    if (assessmentEl && insights.assessment) {
                        assessmentEl.style.opacity = '0';
                        setTimeout(() => {
                            assessmentEl.textContent = insights.assessment;
                            assessmentEl.style.opacity = '1';
                        }, 200);
                    }

                    // Update concerns with animation
                    const concernsList = document.querySelector('#concerns ul');
                    if (concernsList && Array.isArray(insights.concerns)) {
                        concernsList.innerHTML = insights.concerns
                            .map(concern => `
                                <li class="text-red-600 opacity-0 transform translate-y-2 animate-fade-in-up">
                                    ${concern}
                                </li>
                            `)
                            .join('');
                    }

                    // Update recommendations with animation
                    const recommendationsList = document.querySelector('#recommendations ul');
                    if (recommendationsList && Array.isArray(insights.recommendations)) {
                        recommendationsList.innerHTML = insights.recommendations
                            .map(rec => `
                                <li class="text-green-600 opacity-0 transform translate-y-2 animate-fade-in-up">
                                    ${rec}
                                </li>
                            `)
                            .join('');
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching stats:', error);
            });
    }
    
    // Add CSS animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fadeInUp 0.5s ease forwards;
        }
        #assessment p {
            transition: opacity 0.2s ease-in-out;
        }
    `;
    document.head.appendChild(style);
    
    // Update stats every 500ms
    setInterval(updateStats, 500);

    // Function to start webcam
    function startWebcam() {
        fetch('/start_webcam/')
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Failed to start webcam: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error starting webcam:', error);
                alert('Failed to start webcam');
            });
    }
    
    // Function to stop video
    function stopVideo() {
        fetch('/stop_video/')
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Failed to stop video: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error stopping video:', error);
                alert('Failed to stop video');
            });
    }
</script>
{% endblock %}
